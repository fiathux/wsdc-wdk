import timeimport re#Env path parseclass _env_Path(object):    def __init__(I,p):        rexp=re.compile("/{2,}")        p = "/".join(rexp.split(p)) # Clear redundant symbol         I.__pqueue=["/"]        proot = p and p[0]=="/" and p[1:]        proot = (proot and proot[-1]=="/" and proot[:-1]) or proot        if proot: I.__pqueue.extend(proot.split("/"))        I.__current = 0    def current(I): # Get current path        return I.__current>=0 and I.__pqueue[I.__current]    def relative(I): # Get relative path        return (I.__current>=0 and "/".join(I.__pqueue[I.__current+1:])) or False    def pop(I): # Go to next path level        I.__current = (I.__current>=0 and len(I.__pqueue) > I.__current+1 and I.__current+1) or -1        return I.current()    def goback(I): # Back to previous path level        I.__current = (I.__current<0 and len(I.__pqueue)-1) or (I.__current>0 and I.__current-1) or 0        return I.current()    def fullpath(I): # Get full path        return [per for per in I.__pqueue]    def level(I): # Get current path level        return I.__current    def next(I): # Preview next path        return I.__current>=0 and I.__current+1 < len(I.__pqueue) and I.__pqueue[I.__current+1]class wdkEnvException(Exception):pass#Environment evolution containerclass basicEnv(object):    def __init__(I,**arg):        if "instance" not in arg or not arg["instance"]:            raise wdkEnvException("'env' must specify a instance")        I.__env=None # Original env        I.__static=("static" in arg and {k:v for k,v in arg["static"].items()}) or {} # Static data        I.__current=None # Current modify        I.__timestamp=None # Request timestamp        I.path=None        I.inst=arg["instance"] # Instance    # Start new env session    def begin(I,env):        I.__env=env        I.__current={}        I.__timestamp=time.time()        I.path=_env_Path(("PATH_INFO" in env and env["PATH_INFO"]) or "")        return I    def addStatic(I,name,value=None):        I.__static[name]=value    def rmStatic(I,name):        del I.__static[name]    # Get static data    def getStatic(I,name):        return I.__static[name] if name in I.__static else None    # Get original WSGI env data    def getGIEnv(I,name):        return I.__env[name] if name in I.__env else None    def __getitem__(I,name):        if I.__current is None: raise Exception("Enviroment not initialize")        if name in I.__current: return I.__current[name]        elif name in I.__env: return I.__env[name]        elif name in I.__static: return I.__static[name]        else: raise Exception("Key error")    def __setitem__(I,name,value):        I.__current[name]=value    def __iter__(I):        return I.values()    def __contains__(I,name):        return name in I.__current or name in I.__env or name in I.__static    # Get request unix timestamp    def unixTime(I):        return I.__timestamp    # Convert timestamp to string with web format(default output request time)    def webTime(I,tm=None):        return time.strftime("%a, %d %b %Y %H:%M:%S GMT",time.gmtime(tm or I.__timestamp))    def keys(I):        return set().union(set(I.__current.keys()),set(I.__env.keys()),set(I.__static.keys()))    def values(I):        return map(lambda k: I[k], I.keys())    def items(I):        return map(lambda k: (k,I[k]), I.keys())